---
- name: Install Apache as Reverse Proxy

  include_role:
    name: geerlingguy.apache
    apply:
      become: true
  vars:
    apache_state: started
    apache_create_vhosts: true
    apache_remove_default_vhost: true
    apache_allow_override: None
    apache_mods_enabled:
    - rewrite.load
    - status.load
    - proxy_http.load
    - proxy.load

    apache_global_vhost_settings: |
      ServerTokens Prod
      ServerSignature Off
      LogFormat "%{X-Forwarded-For}i %h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined

    apache_vhosts:
{% for vhost in reverse_proxy.vhosts %}
    - servername: "{{ vhost.domain }}"
      serveralias: "{{ vhost.domain }}"
      serveradmin: "{{ reverse_proxy.email }}"
      extra_parameters: |
        ProxyPass / http://{{ vhost.backend_endpoint }}/
        ProxyPassReverse / http://{{ vhost.backend_endpoint }}/
        
        ErrorLog ${APACHE_LOG_DIR}/{{ vhost.name }}-error.log
        CustomLog ${APACHE_LOG_DIR}/{{ vhost.name }}-access.log combined
{% endfor %}
